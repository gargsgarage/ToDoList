/*
 * This source file was generated by the Gradle 'init' task
 */
package org.example;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.util.Scanner;

import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpServer;

public class TODOServer {

    public static void main(String[] args) {
        // create the server
        TODOServer server = new TODOServer();
        // link it to an HTTP server
        server.startTODOListService();
    }

    /**
     * 
     */
    public void startTODOListService() {
        try {
            // create HTTP server
            HttpServer httpServer = HttpServer.create();
            // set up a path to handle requests and call the handler
            // associated with it to generate the response
            httpServer.createContext("/todos", new TODOListHandler());
            // tell the server to see what port to listen to
            httpServer.bind(new InetSocketAddress(8080), 0);

            httpServer.start();
        } catch (Exception e) {
            e.printStackTrace();
        }

    }

    public class TODOListHandler implements HttpHandler {

        @Override
        public void handle(HttpExchange exchange) throws IOException {

            //figure out which type of request needs to be handled
            String requestMethod = exchange.getRequestMethod();

            if(requestMethod.equalsIgnoreCase("GET")){
                // handle the request coming in the /todo path
                String body = "todo: 1, 2, 3";

                // send the response headers
                exchange.sendResponseHeaders(200, body.length());
                // send the response body
                exchange.getResponseBody().write(body.getBytes());
            }
            else if(requestMethod.equalsIgnoreCase("POST")){
                
                String body = """
                    <!DOCTYPE html>
                    <html lang=\"en\">
                    <head>
                        <meta charset=\"UTF-8\">
                        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
                        <title>Add Task</title>
                    </head>
                    <body>
                        <h1>Add Task</h1>
                        <form method=\"post\" action=\"/todos\">
                            <label for=\"taskTitle\">Task Title:</label><br>
                            <input type=\"text\" id=\"taskTitle\" name=\"taskTitle\"><br>
                            <input type=\"submit\" value=\"Add Task\">
                        </form>

                        """;

                
                //scan the user input
                Scanner sc = new Scanner(exchange.getRequestBody());
                String userInput;
                if(sc.hasNext()){
                    userInput = sc.next();
                }
                else{
                    userInput = "";
                }
                body += "<p> Task created: " + userInput + "<p>\n";
                sc.close();
                

                //close the remaining tags
                body += """
                        </body>
                        </html>
                        """;

                exchange.sendResponseHeaders(200, body.length());
                exchange.getResponseBody().write(body.getBytes());

            }
            

        }

    }

}
